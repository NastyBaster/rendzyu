<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Рендзю онлайн</title>
  <style>
    body { display: flex; justify-content: center; align-items: center; flex-direction: column; height: 100vh; background: #f0f0f0; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
    .hidden { display: none !important; }
    
    /* Стилі для лобі */
    .lobby-container { text-align: center; }
    .lobby-container button { font-size: 20px; padding: 15px 30px; cursor: pointer; margin: 10px; }
    #join-screen input { font-size: 24px; padding: 10px; text-align: center; width: 150px; margin-bottom: 10px; }

    #game-layout { display: flex; align-items: flex-start; gap: 20px; }
    #game-container { display: flex; flex-direction: column; align-items: center; }
    #game-code-display { font-size: 18px; font-weight: bold; background: #fff; padding: 5px 10px; border-radius: 5px; margin-top: 5px; }
    canvas { background: #f9d58a; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); cursor: pointer; }
    button { margin-top: 10px; padding: 8px 15px; font-size: 16px; cursor: pointer; border: 1px solid #ccc; border-radius: 5px; }
    #turn-indicator { font-family: sans-serif; color: #333; height: 50px; margin-bottom: 5px; margin-top: 10px; text-align: center; }
    
    #chat-container { width: 250px; height: 600px; display: flex; flex-direction: column; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 5px; }
    /* ... інші стилі ... */

    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    #winner-modal { background: white; padding: 25px 50px; border-radius: 10px; text-align: center; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); }
  </style>
</head>
<body>

  <div id="lobby" class="lobby-container">
    <h1>Рендзю</h1>
    <button id="create-game-btn">Створити гру</button>
    <button id="join-game-btn">Приєднатися до гри</button>
  </div>
  
  <div id="join-screen" class="lobby-container hidden">
    <h2>Введіть код гри</h2>
    <form id="join-form">
      <input type="number" id="game-code-input" placeholder="Код з 3 цифр" required>
      <button type="submit">Приєднатися</button>
    </form>
    <button id="back-to-lobby">Назад</button>
  </div>

  <div id="game-layout" class="hidden">
    <!-- ... решта вашого HTML для гри ... -->
  </div>

  <div id="overlay" class="hidden">
    <div id="winner-modal">
      <h2 id="winner-message"></h2>
      <button id="play-again">Повернутись в лобі</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove, onDisconnect, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = { /* ... Ваші дані Firebase ... */ };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // Елементи лобі
    const lobbyDiv = document.getElementById('lobby');
    const joinScreenDiv = document.getElementById('join-screen');
    const createGameBtn = document.getElementById('create-game-btn');
    const joinGameBtn = document.getElementById('join-game-btn');
    const joinForm = document.getElementById('join-form');
    const gameCodeInput = document.getElementById('game-code-input');
    const backToLobbyBtn = document.getElementById('back-to-lobby');
    
    const gameLayoutDiv = document.getElementById('game-layout');
    
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('game');

    let myName = localStorage.getItem('playerName');
    if (!myName) {
        myName = prompt("Будь ласка, введіть ваше ім'я:") || 'Анонім';
        localStorage.setItem('playerName', myName);
    }
    
    // --- ЛОГІКА ЛОБІ ТА КІМНАТ ---
    if (gameId) {
        lobbyDiv.classList.add('hidden');
        joinScreenDiv.classList.add('hidden');
        gameLayoutDiv.classList.remove('hidden');
        initGame(gameId);
    }

    createGameBtn.addEventListener('click', () => {
        const newGameId = Math.floor(100 + Math.random() * 900).toString(); // Код 100-999
        window.location.href = `?game=${newGameId}`;
    });
    
    joinGameBtn.addEventListener('click', () => {
        lobbyDiv.classList.add('hidden');
        joinScreenDiv.classList.remove('hidden');
    });
    
    backToLobbyBtn.addEventListener('click', () => {
        joinScreenDiv.classList.add('hidden');
        lobbyDiv.classList.remove('hidden');
    });

    joinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = gameCodeInput.value;
        if (code && code.length === 3) {
            const gameRef = ref(db, `games/${code}`);
            const snapshot = await get(gameRef);
            if (snapshot.exists()) {
                window.location.href = `?game=${code}`;
            } else {
                alert("Гра з таким кодом не знайдена. Перевірте код.");
            }
        } else {
            alert("Будь ласка, введіть код з 3 цифр.");
        }
    });

    // --- ОСНОВНА ЛОГІКА ГРИ ---
    function initGame(currentGameId) {
        // ... тут весь ваш код initGame, але з однією зміною в resetGame ...
        const winnerRef = ref(db, `games/${currentGameId}/winner`); // <-- НОВЕ ПОСИЛАННЯ

        // ...
        
        onValue(winnerRef, (snapshot) => {
            const winner = snapshot.val();
            if (winner) {
                showWinner(winner);
            }
        });
        
        canvas.addEventListener("click",e=>{ 
            // ...
            if(checkWinner(x,y,current)){
                set(winnerRef, current); // <-- ЗАПИСУЄМО ПЕРЕМОЖЦЯ В БАЗУ
                return;
            } 
            set(currentRef,current==="black"?"white":"black"); 
        });
        
        function resetGame() { 
            remove(gameRef); 
            window.location.href = window.location.pathname; // <-- Повертаємось в лобі
        }
        
        playAgainButton.textContent = "Повернутись в лобі"; // <-- Змінюємо текст кнопки
        
        resetButton.addEventListener("click", resetGame);
        playAgainButton.addEventListener("click", resetGame);
        
        // Додаємо відображення коду гри
        const codeDisplay = document.createElement('p');
        codeDisplay.id = 'game-code-display';
        codeDisplay.textContent = `Код гри: ${currentGameId}`;
        gameContainer.appendChild(codeDisplay);
        
        drawBoard();
    }
  </script>
</body>
</html>